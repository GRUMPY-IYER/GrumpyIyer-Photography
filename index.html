<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Grumpy Iyer - Photography</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #fafaf9; }
    
    /* Disable right-click and image dragging globally */
    img { 
      -webkit-user-drag: none;
      -khtml-user-drag: none;
      -moz-user-drag: none;
      -o-user-drag: none;
      user-drag: none;
      pointer-events: none;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }
    
    .header { background: white; border-bottom: 1px solid #e7e5e4; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; }
    .logo { display: flex; align-items: center; gap: 1rem; }
    .logo-circle { width: 40px; height: 40px; background: #78350f; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-family: serif; }
    .logo-text h1 { font-size: 1.5rem; font-family: serif; color: #1c1917; }
    .logo-text p { font-size: 0.75rem; color: #78716c; }
    .nav { display: flex; gap: 1.5rem; align-items: center; }
    .nav button { background: none; border: none; cursor: pointer; color: #78716c; font-size: 1rem; padding: 0.5rem 1rem; }
    .nav button:hover { color: #78350f; }
    .nav button.active { color: #78350f; font-weight: 600; }
    .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
    .filter-bar { display: flex; gap: 0.5rem; margin-bottom: 2rem; }
    .filter-btn { padding: 0.5rem 1.5rem; border: 1px solid #e7e5e4; background: white; border-radius: 2rem; cursor: pointer; color: #57534e; font-size: 0.875rem; }
    .filter-btn:hover { background: #f5f5f4; }
    .filter-btn.active { background: #78350f; color: white; border-color: #78350f; }
    .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 2rem; }
    .photo-card { background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; cursor: pointer; transition: box-shadow 0.3s; }
    .photo-card:hover { box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
    .photo-card img { width: 100%; height: 250px; object-fit: cover; pointer-events: none; user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; }
    .photo-info { padding: 1rem; }
    .photo-info h3 { font-family: serif; font-size: 1.125rem; margin-bottom: 0.5rem; color: #1c1917; }
    .photo-meta { display: flex; justify-content: space-between; font-size: 0.875rem; }
    .photo-meta .category { color: #78716c; }
    .photo-meta .price { color: #78350f; font-weight: 600; }
    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 100; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: white; max-width: 900px; max-height: 90vh; overflow-y: auto; position: relative; }
    .modal-content img { width: 100%; max-height: 60vh; object-contain: contain; pointer-events: none; user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; -webkit-touch-callout: none; }
    .modal-info { padding: 2rem; }
    .modal-info .hook { font-style: italic; color: #78350f; font-size: 1.125rem; margin-bottom: 1rem; }
    .modal-info h2 { font-family: serif; font-size: 2rem; margin-bottom: 1rem; }
    .modal-info .philosophy { color: #57534e; line-height: 1.6; margin-bottom: 1.5rem; }
    .modal-footer { border-top: 1px solid #e7e5e4; padding-top: 1.5rem; display: flex; justify-content: space-between; align-items: center; }
    .modal-footer .price { font-family: serif; font-size: 1.5rem; color: #78350f; }
    .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem; cursor: pointer; font-size: 1rem; font-weight: 500; }
    .btn-primary { background: #78350f; color: white; }
    .btn-primary:hover { background: #92400e; }
    .close-btn { position: absolute; top: 1rem; right: 1rem; background: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.5rem; }
    .admin-panel { background: white; padding: 2rem; border-radius: 0.5rem; margin-top: 2rem; }
    .admin-header { display: flex; justify-content: space-between; margin-bottom: 2rem; }
    .admin-header h2 { font-family: serif; font-size: 2rem; }
    .admin-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; }
    .admin-card { background: #fafaf9; padding: 1rem; border-radius: 0.5rem; }
    .admin-card img { width: 100%; height: 150px; object-fit: cover; border-radius: 0.5rem; margin-bottom: 0.5rem; }
    .admin-actions { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
    .btn-small { padding: 0.5rem 1rem; font-size: 0.875rem; }
    .btn-edit { background: #2563eb; color: white; }
    .btn-delete { background: #dc2626; color: white; }
    .form-modal { padding: 2rem; max-width: 600px; }
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.5rem; border: 1px solid #e7e5e4; border-radius: 0.5rem; font-size: 1rem; }
    .form-group textarea { resize: vertical; }
    .preview-img { width: 100%; height: 200px; object-fit: cover; border-radius: 0.5rem; margin-top: 0.5rem; }
    .login-modal { padding: 2rem; max-width: 400px; text-align: center; }
    .login-modal h2 { font-family: serif; margin-bottom: 1.5rem; }
    .login-modal input { width: 100%; padding: 0.75rem; border: 1px solid #e7e5e4; border-radius: 0.5rem; margin-bottom: 1rem; }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="logo">
      <div class="logo-circle">GI</div>
      <div class="logo-text">
        <h1>Grumpy Iyer</h1>
        <p>Photography & Philosophy</p>
      </div>
    </div>
    <div class="nav">
      <button id="galleryBtn" class="active">Gallery</button>
      <button id="adminBtn" style="display:none;">Admin</button>
      <button id="loginBtn">ðŸ”’</button>
      <button id="cartBtn">ðŸ›’ <span id="cartCount"></span></button>
    </div>
  </div>

  <!-- Gallery View -->
  <div id="galleryView" class="container">
    <div class="filter-bar">
      <button class="filter-btn active" data-category="All">All</button>
      <button class="filter-btn" data-category="Wildlife">Wildlife</button>
      <button class="filter-btn" data-category="Landscape">Landscape</button>
    </div>
    <div class="gallery" id="gallery"></div>
  </div>

  <!-- Admin View -->
  <div id="adminView" class="container" style="display:none;">
    <div class="admin-panel">
      <div class="admin-header">
        <div>
          <h2>Admin Panel</h2>
          <p style="font-size:0.875rem;color:#78716c;margin-top:0.25rem;">
            Deployed: <span id="versionDisplay"></span><br>
            Build: <span id="buildDisplay"></span>
          </p>
        </div>
        <button class="btn btn-primary" onclick="event.stopPropagation(); openPhotoForm(null);">+ Add Photo</button>
      </div>
      <div class="admin-grid" id="adminGallery"></div>
    </div>
  </div>

  <!-- Photo Detail Modal -->
  <div id="photoModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" onclick="closePhotoModal()">Ã—</button>
      <img id="modalImg" src="" alt="">
      <div class="modal-info">
        <p class="hook" id="modalHook"></p>
        <h2 id="modalTitle"></h2>
        <p class="philosophy" id="modalPhilosophy"></p>
        <div class="modal-footer">
          <span class="price" id="modalPrice"></span>
          <button class="btn btn-primary" onclick="addToCartFromModal()">Add to Cart</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Photo Form Modal -->
  <div id="formModal" class="modal">
    <div class="modal-content form-modal">
      <button class="close-btn" onclick="closeFormModal()">Ã—</button>
      <h2 id="formTitle">Add Photo</h2>
      <form id="photoForm">
        <div class="form-group">
          <label>Photo Upload</label>
          <input type="file" id="photoFile" accept="image/*" required>
          <img id="previewImg" class="preview-img" style="display:none;">
        </div>
        <div class="form-group">
          <label>Title</label>
          <input type="text" id="photoTitle" required>
        </div>
        <div class="form-group">
          <label>Category</label>
          <select id="photoCategory">
            <option>Wildlife</option>
            <option>Landscape</option>
          </select>
        </div>
        <div class="form-group">
          <label>Price ($)</label>
          <input type="number" id="photoPrice" value="150">
        </div>
        <div class="form-group">
          <label>Hook Line</label>
          <input type="text" id="photoHook">
        </div>
        <div class="form-group">
          <label>Philosophy / Description</label>
          <textarea id="photoPhilosophy" rows="5"></textarea>
        </div>
        <button type="submit" class="btn btn-primary" style="width:100%;">Save Photo</button>
      </form>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="loginModal" class="modal">
    <div class="modal-content login-modal">
      <button class="close-btn" onclick="closeLoginModal()">Ã—</button>
      <h2>Admin Login</h2>
      <input type="password" id="passwordInput" placeholder="Enter password">
      <button class="btn btn-primary" onclick="handleLogin()" style="width:100%;">Login</button>
    </div>
  </div>

  <!-- Cart Modal -->
  <div id="cartModal" class="modal">
    <div class="modal-content form-modal">
      <button class="close-btn" onclick="closeCartModal()">Ã—</button>
      <h2>Shopping Cart</h2>
      <div id="cartItems"></div>
      <div id="cartTotal" style="margin-top:1rem;font-size:1.25rem;font-weight:bold;"></div>
      <button class="btn btn-primary" onclick="checkout()" style="width:100%;margin-top:1rem;">Checkout</button>
    </div>
  </div>

  <script>
    const VERSION = 'Dec 19, 2024 - 12:00 PM EST';
    const BUILD = '2024.12.19.003'; // Image Protection Added
    const ADMIN_PASSWORD = 'grumpy2024';
    
    // Cloudinary Configuration
    const CLOUDINARY_CLOUD_NAME = 'dzudd8xbx';
    const CLOUDINARY_UPLOAD_PRESET = 'grumpyiyer_unsigned';
    const CLOUDINARY_UPLOAD_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;
    let isAdmin = false;
    let editingPhotoId = null;
    let selectedPhoto = null;
    let cart = [];

    // Load photos from localStorage or use defaults
    let photos = JSON.parse(localStorage.getItem('grumpyiyer_photos')) || [
      { id: 1, title: "Cheetah on the Serengeti Plains", category: "Wildlife", price: 150, url: "https://images.unsplash.com/photo-1551969014-7d2c4cddf0b6?w=1200", hookLine: "In stillness, the hunter waits", philosophy: "The cheetah embodies witness consciousness - alert, present, yet completely at peace.", likes: 24 },
      { id: 2, title: "Golden Hour Savanna", category: "Landscape", price: 120, url: "https://images.unsplash.com/photo-1516426122078-c23e76319801?w=1200", hookLine: "Where earth meets infinity", philosophy: "The vast savanna reveals the illusion of separation.", likes: 18 }
    ];

    let currentCategory = 'All';

    // Save photos to localStorage
    function savePhotosToStorage() {
      localStorage.setItem('grumpyiyer_photos', JSON.stringify(photos));
    }

    // Initialize
    function init() {
      document.getElementById('versionDisplay').textContent = VERSION;
      document.getElementById('buildDisplay').textContent = BUILD;
      renderGallery();
      setupEventListeners();
      disableImageProtection();
    }
    
    // Disable right-click and image protection
    function disableImageProtection() {
      // Disable right-click on entire document
      document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        return false;
      });
      
      // Disable keyboard shortcuts for saving images
      document.addEventListener('keydown', function(e) {
        // Disable Ctrl+S, Cmd+S (Save)
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
          e.preventDefault();
          return false;
        }
        // Disable Ctrl+Shift+I, Cmd+Option+I (Inspect)
        if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'I') {
          e.preventDefault();
          return false;
        }
        // Disable F12 (DevTools)
        if (e.key === 'F12') {
          e.preventDefault();
          return false;
        }
      });
      
      // Disable drag and drop
      document.addEventListener('dragstart', function(e) {
        if (e.target.tagName === 'IMG') {
          e.preventDefault();
          return false;
        }
      });
      
      // Add watermark overlay on hover (optional extra protection)
      document.querySelectorAll('img').forEach(img => {
        img.style.position = 'relative';
      });
    }

    function setupEventListeners() {
      document.getElementById('galleryBtn').addEventListener('click', () => showView('gallery'));
      document.getElementById('adminBtn').addEventListener('click', () => showView('admin'));
      document.getElementById('loginBtn').addEventListener('click', () => document.getElementById('loginModal').classList.add('active'));
      document.getElementById('cartBtn').addEventListener('click', openCart);
      document.getElementById('photoForm').addEventListener('submit', savePhoto);
      document.getElementById('photoFile').addEventListener('change', previewImage);

      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          e.target.classList.add('active');
          currentCategory = e.target.dataset.category;
          renderGallery();
        });
      });
    }

    function showView(view) {
      console.log('Showing view:', view);
      console.log('Total photos:', photos.length);
      console.log('Current category:', currentCategory);
      
      document.getElementById('galleryView').style.display = view === 'gallery' ? 'block' : 'none';
      document.getElementById('adminView').style.display = view === 'admin' ? 'block' : 'none';
      document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
      if (view === 'gallery') {
        document.getElementById('galleryBtn').classList.add('active');
        renderGallery();
      }
      if (view === 'admin') {
        document.getElementById('adminBtn').classList.add('active');
        renderAdminGallery();
      }
    }

    function renderGallery() {
      const filtered = currentCategory === 'All' ? photos : photos.filter(p => p.category === currentCategory);
      console.log('Rendering gallery. Filtered photos:', filtered.length);
      console.log('Photos:', filtered);
      
      const html = filtered.map(p => `
        <div class="photo-card" onclick="openPhotoModal(${p.id})">
          <img src="${p.url}" alt="${p.title}">
          <div class="photo-info">
            <h3>${p.title}</h3>
            <div class="photo-meta">
              <span class="category">${p.category}</span>
              <span class="price">${p.price}</span>
            </div>
          </div>
        </div>
      `).join('');
      document.getElementById('gallery').innerHTML = html;
      console.log('Gallery HTML updated');
    }

    function renderAdminGallery() {
      const html = photos.map(p => `
        <div class="admin-card">
          <img src="${p.url}" alt="${p.title}">
          <h4>${p.title}</h4>
          <p>${p.category} Â· $${p.price}</p>
          <div class="admin-actions">
            <button class="btn btn-small btn-edit" onclick="editPhoto(${p.id})">Edit</button>
            <button class="btn btn-small btn-delete" onclick="deletePhoto(${p.id})">Delete</button>
          </div>
        </div>
      `).join('');
      document.getElementById('adminGallery').innerHTML = html;
    }

    function openPhotoModal(id) {
      selectedPhoto = photos.find(p => p.id === id);
      if (!selectedPhoto) return;
      document.getElementById('modalImg').src = selectedPhoto.url;
      document.getElementById('modalTitle').textContent = selectedPhoto.title;
      document.getElementById('modalHook').textContent = selectedPhoto.hookLine;
      document.getElementById('modalPhilosophy').textContent = selectedPhoto.philosophy;
      document.getElementById('modalPrice').textContent = '$' + selectedPhoto.price;
      document.getElementById('photoModal').classList.add('active');
    }

    function closePhotoModal() {
      document.getElementById('photoModal').classList.remove('active');
      selectedPhoto = null;
    }

    function openPhotoForm(id) {
      // Explicitly check if id is null or undefined
      if (id === null || id === undefined || typeof id === 'object') {
        id = null;
      }
      
      editingPhotoId = id;
      console.log('Opening photo form. Editing ID:', editingPhotoId);
      document.getElementById('formTitle').textContent = id ? 'Edit Photo' : 'Add Photo';
      
      if (id && typeof id === 'number') {
        const photo = photos.find(p => p.id === id);
        if (photo) {
          document.getElementById('photoTitle').value = photo.title;
          document.getElementById('photoCategory').value = photo.category;
          document.getElementById('photoPrice').value = photo.price;
          document.getElementById('photoHook').value = photo.hookLine || '';
          document.getElementById('photoPhilosophy').value = photo.philosophy || '';
          document.getElementById('previewImg').src = photo.url;
          document.getElementById('previewImg').style.display = 'block';
        }
      } else {
        document.getElementById('photoForm').reset();
        document.getElementById('previewImg').style.display = 'none';
        document.getElementById('photoPrice').value = '150';
      }
      document.getElementById('formModal').classList.add('active');
    }

    function closeFormModal() {
      document.getElementById('formModal').classList.remove('active');
      editingPhotoId = null;
    }

    function previewImage(e) {
      const file = e.target.files[0];
      if (file) {
        // Check file size (max 10MB for free tier)
        if (file.size > 10 * 1024 * 1024) {
          alert('File too large! Please choose an image under 10MB.');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById('previewImg').src = e.target.result;
          document.getElementById('previewImg').style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    }

    function savePhoto(e) {
      e.preventDefault();
      
      const fileInput = document.getElementById('photoFile');
      const previewImg = document.getElementById('previewImg');
      
      // Check if we're editing (already has URL) or adding new (need to upload)
      if (editingPhotoId && typeof editingPhotoId === 'number') {
        // Editing existing photo - save without re-uploading unless new file selected
        if (fileInput.files.length === 0) {
          // No new file, just update metadata
          savePhotoMetadata(previewImg.src);
          return;
        }
      }
      
      // Check if file is selected
      if (!fileInput.files || fileInput.files.length === 0) {
        alert('Please select a photo to upload!');
        return;
      }
      
      const file = fileInput.files[0];
      
      // Show uploading message
      const formButton = document.querySelector('#photoForm button[type="submit"]');
      const originalButtonText = formButton.textContent;
      formButton.textContent = 'Uploading to Cloudinary...';
      formButton.disabled = true;
      
      // Upload to Cloudinary
      uploadToCloudinary(file)
        .then(cloudinaryUrl => {
          console.log('Cloudinary URL:', cloudinaryUrl);
          savePhotoMetadata(cloudinaryUrl);
          formButton.textContent = originalButtonText;
          formButton.disabled = false;
        })
        .catch(error => {
          console.error('Upload error:', error);
          alert('Failed to upload photo. Please try again.');
          formButton.textContent = originalButtonText;
          formButton.disabled = false;
        });
    }
    
    function uploadToCloudinary(file) {
      return new Promise((resolve, reject) => {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
        formData.append('folder', 'photography');
        
        fetch(CLOUDINARY_UPLOAD_URL, {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.secure_url) {
            resolve(data.secure_url);
          } else {
            reject(new Error('No URL in response'));
          }
        })
        .catch(error => reject(error));
      });
    }
    
    function savePhotoMetadata(photoUrl) {
      // Generate a proper numeric ID for new photos
      const newId = editingPhotoId && typeof editingPhotoId === 'number' ? editingPhotoId : Date.now();
      
      const photo = {
        id: newId,
        title: document.getElementById('photoTitle').value,
        category: document.getElementById('photoCategory').value,
        price: parseInt(document.getElementById('photoPrice').value),
        hookLine: document.getElementById('photoHook').value || '',
        philosophy: document.getElementById('photoPhilosophy').value || '',
        url: photoUrl,
        likes: 0
      };

      console.log('Saving photo with ID:', photo.id, 'Type:', typeof photo.id);
      console.log('Is editing?', editingPhotoId, 'Type:', typeof editingPhotoId);

      if (editingPhotoId && typeof editingPhotoId === 'number') {
        const index = photos.findIndex(p => p.id === editingPhotoId);
        if (index !== -1) {
          photos[index] = { ...photos[index], ...photo };
          console.log('Updated existing photo at index', index);
        }
      } else {
        photos.push(photo);
        console.log('Added new photo');
      }

      console.log('Total photos after save:', photos.length);
      savePhotosToStorage();
      closeFormModal();
      renderGallery();
      renderAdminGallery();
      alert('Photo saved successfully!');
    }

    function editPhoto(id) {
      openPhotoForm(id);
    }

    function deletePhoto(id) {
      if (confirm('Delete this photo?')) {
        photos = photos.filter(p => p.id !== id);
        savePhotosToStorage();
        renderAdminGallery();
        renderGallery();
      }
    }

    function handleLogin() {
      const password = document.getElementById('passwordInput').value;
      if (password === ADMIN_PASSWORD) {
        isAdmin = true;
        document.getElementById('adminBtn').style.display = 'block';
        document.getElementById('loginBtn').textContent = 'ðŸ”“';
        closeLoginModal();
        alert('Logged in successfully!');
      } else {
        alert('Incorrect password');
      }
    }

    function closeLoginModal() {
      document.getElementById('loginModal').classList.remove('active');
      document.getElementById('passwordInput').value = '';
    }

    function addToCartFromModal() {
      if (selectedPhoto) {
        const existing = cart.find(item => item.id === selectedPhoto.id);
        if (existing) {
          existing.quantity++;
        } else {
          cart.push({ ...selectedPhoto, quantity: 1 });
        }
        updateCartCount();
        closePhotoModal();
        alert('Added to cart!');
      }
    }

    function updateCartCount() {
      const count = cart.reduce((sum, item) => sum + item.quantity, 0);
      document.getElementById('cartCount').textContent = count > 0 ? count : '';
    }

    function openCart() {
      if (cart.length === 0) {
        document.getElementById('cartItems').innerHTML = '<p style="text-align:center;color:#78716c;padding:2rem;">Your cart is empty</p>';
        document.getElementById('cartTotal').innerHTML = '';
      } else {
        const html = cart.map(item => `
          <div style="display:flex;gap:1rem;background:#fafaf9;padding:1rem;border-radius:0.5rem;margin-bottom:1rem;">
            <img src="${item.url}" style="width:80px;height:80px;object-fit:cover;border-radius:0.5rem;">
            <div style="flex:1;">
              <h4>${item.title}</h4>
              <p style="color:#78716c;font-size:0.875rem;">${item.category}</p>
              <p style="font-weight:600;">$${item.price * item.quantity}</p>
            </div>
          </div>
        `).join('');
        const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        document.getElementById('cartItems').innerHTML = html;
        document.getElementById('cartTotal').innerHTML = `Total: <span style="color:#78350f;">$${total}</span>`;
      }
      document.getElementById('cartModal').classList.add('active');
    }

    function closeCartModal() {
      document.getElementById('cartModal').classList.remove('active');
    }

    function checkout() {
      alert('Payment processing would happen here!');
      cart = [];
      updateCartCount();
      closeCartModal();
    }

    // Start the app
    init();
  </script>
</body>
</html>
